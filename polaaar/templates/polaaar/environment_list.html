{% extends "polaaar/base.html" %}
{% load static humanize url_replace leaflet_tags %}

{% block title %}
    Environmental metadata search
{% endblock title %}

{% block body_class %}{% endblock %}

{% block content %}
    <div class="container mt-4">
        <h3>Search for sequences based on environmental metadata</h3>
        <small class="text-muted">For more advanced search queries, please use the <a
                href="{% url 'polaaar:api_reference' %}">API</a></small>
        <form action="." method="get">
            <div class="form-row">
                <div class="form-group col-md-4">
                    <label for="{{ form.variable.id_for_label }}">Environmental metadata</label>
                    {{ form.variable }}
                </div>
                <div class="form-group col-md-4">
                    <label for="{{ form.text.id_for_label }}">Text search</label>
                    {{ form.text }}
                </div>
                <div class="form-group col-md-1">
                    <label for="{{ form.min_value.id_for_label }}">Min value</label>
                    {{ form.min_value }}
                </div>
                <div class="form-group col-md-1">
                    <label for="{{ form.max_value.id_for_label }}">Max value</label>
                    {{ form.max_value }}
                </div>
            </div>
            <input type="submit" value="Submit" role="button" class="btn btn-biodiversity-lightblue">

        </form>
        <hr/>
        {% if page_obj.object_list %}
            <p>{{ page_obj.start_index }} - {{ page_obj.end_index }} of {{ page_obj.paginator.count|intcomma }}
                results</p>
            {% if is_paginated %}
                {% include 'polaaar/pagination.html' %}
            {% endif %}
            <div class="table-responsive text-nowrap mt-5">
                <table class="table table-striped table-sm">
                    <thead>
                    <tr>
                        <th scope="col">Variable</th>
                        <th scope="col">Text value</th>
                        <th scope="col">Numeric value</th>
                        <th scope="col">Unit</th>
                        <th scope="col">Sequences accession number</th>
                        <th scope="col">Bioproject</th>
                        <th scope="col">Project</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for env in page_obj.object_list %}
                        <tr>
                            <td>{{ env.env_variable.name }}</td>
                            <td>{{ env.env_text_value|default_if_none:"" }}</td>
                            <td>{{ env.env_numeric_value|default_if_none:"" }}</td>
                            <td>{{ env.env_units|default_if_none:"" }}</td>
                            <td>{{ env.event.sequences.seqData_accessionNumber }}</td>
                            <td>{{ env.event.sequences.seqData_projectNumber }}</td>
                            <td>
                                <a href="{% url 'polaaar:project_metadata_detail' env.event.project_metadata_id %}">{{ env.event.project_metadata }}</a>
                            </td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
            <div class="row-cols-12">
                <div class="col-4 col-md-3">
                    <a class="btn btn-biodiversity-lightblue btn-lg" style="width:100%"
                       href="{% url 'polaaar:export_environment' %}?id={{ id_list }}">Download EXCEL <i
                            class="fas fa-file-excel pl-1"></i></a>
                </div>
                <div class="col-4 col-md-3">
                    <a class="btn btn-biodiversity-lightblue btn-lg" style="width:100%"
                       href="{% url 'polaaar:environment-list' %}?id__in={{ id_list }}">Download JSON <i
                            class="fas fa-file-code pl-1"></i></a>
                </div>
            </div>

        {% else %}
            <p>Sorry, no result</p>
        {% endif %}
        <div class="row justify-content-center mt-5">
            <div class="col-9" id="env-map" style="height:500px;">
                {% leaflet_map "landing_map" callback="window.map_init" %}

                <p style="font-size:10pt;color:white">Map attribution: Tiles &copy; Esri &mdash; Source: Esri, DeLorme,
                    NAVTEQ, USGS, Intermap, iPC, NRCAN, Esri Japan, METI, Esri China (Hong Kong), Esri (Thailand),
                    TomTom, 2012</p>
            </div>
        </div>
    </div>




{% endblock %}

{% block polaaar_js %}
    <script type="text/javascript">
        let geojsonFeature = {{ event_geojson|safe }}

            function map_init(map, options) {
                let geojsonMarkerOptions = {
                    radius: 3,
                    fillColor: "#FF0080",
                    color: "#FF0080",
                    weight: 1,
                    opacity: 1,
                    fillOpacity: 0.3
                };

                function onEachFeature(feature, layer) {
                    // does this feature have a property named sample_name?
                    if (feature.properties && feature.properties.project_metadata) {
                        layer.bindPopup(feature.properties.project_metadata);
                    }
                }

                let tileLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}', {
                    attribution: ''
                })
                tileLayer.addTo(map);
                L.geoJSON(geojsonFeature, {
                    pointToLayer: function (feature, latlng) {
                        return L.circleMarker(latlng, geojsonMarkerOptions);
                    },
                    onEachFeature: onEachFeature
                }).addTo(map);


            }


    </script>
{% endblock %}
