{% load static leaflet_tags geojson_tags polaaar_tags %}


<div class="row" style="border-width:0px;">
    <div class="col-12">

        <table id="myTable" class="display">
            <thead>
                <tr>
                    <th style="display:none">coordinates</th>
                    <th>Project creator</th>
                    <th>Project name</th>
                    <th>Start date</th>
                    <th>End date</th>
                    <th>Occurrences</th>
                    <th>Sequences</th>
                    <th>Download</th>
                </tr>
            </thead>
            <tbody>
                {% for i in qs %}
                <tr>
                    <td style="display:none">
                        {% for xx in i.event_hierarchy.all %}
                        {% for xy in xx.event.all %}
                        [{{xy.Longitude}},{{xy.Latitude}}]
                        {% endfor %}
                        {% endfor %}
                    </td>
                    <td>{{i.project_creator.full_name}}</td>
                    <td>{{i.project_name}}</td>
                    <td>{{i.start_date}}</td>
                    <td>{{i.end_date}}</td>
                    <td style="text-align:center;font-size:16pt">
                        {% if i|getTrueOccurrence == "True" %}
                        <i style="color:green;" class="fas fa-check-circle pl-1"></i>
                        {% else %}
                        <i style="color:red" class="fas fa-times-circle pl-1"></i>
                        {% endif %}
                    </td>
                    <td style="text-align:center;font-size:16pt">
                        {% if i|getTrueSequences == "True" %}
                        <i style="color:green;" class="fas fa-check-circle pl-1"></i>
                        {% else %}
                        <i style="color:red" class="fas fa-times-circle pl-1"></i>
                        {% endif %}
                    </td>
                    <td style="font-size:25pt;color:black">
                        <a href="#"><i class="fas fa-file-csv pl-1"></i></a>
                        <a href="/polaaar/project_metadata/{{i.pk}}"><i class="fas fa-file-code pl-1"></i></a>
                    </td>
                </tr>



                {% endfor %}
            </tbody>
        </table>




    </div>
    <div class="col-3">
        <button class="btn btn-elegant btn-lg" style="width:100%" onclick="map_refresh(landing_map)">Refresh map</button>
    </div>
</div>


<div class="row justify-content-center">
    <div class="col-md-6">

        {% leaflet_map "project_map" callback="window.map_init2"  %}


    </div>
</div>



<script>
    $(document).ready(function () {
        $('#myTable').DataTable();
    });

</script>



<style>

    .leaflet-container { /* all maps */
        width: 100%;
        height: 400px;
        -webkit-box-shadow: 10px 10px 42px 0px rgba(0,0,0,0.75);
        -moz-box-shadow: 10px 10px 42px 0px rgba(0,0,0,0.75);
        box-shadow: 10px 10px 42px 0px rgba(0,0,0,0.75);
    }

    #specialbigmap {
        height: 800px;
    }

    /* Resize the "display_raw" textbox */
    .django-leaflet-raw-textarea {
        width: 100%;
    }
</style>

<script type="text/javascript">
    // Javascript will load the data initially from the database and then use the hidden coordinates column to re-populate a new set of markers


    var collection = {{ qs_results|geojsonfeature|safe }};

    var newMarkers = L.featureGroup();

    var geojsonMarkerOptions = {
            radius: 3,
            fillColor: "#ff7800",
            color: "#000",
            weight: 1,
            opacity: 1,
            fillOpacity: 0.8
        };

    newMarkers.setStyle(geojsonMarkerOptions)

    var ggJSON = L.geoJson(collection,{
            pointToLayer: function(feature,latlng){
                return L.circleMarker(latlng,geojsonMarkerOptions);
            }
        })

    function map_init2(map, options) {
         ggJSON.addTo(map);
         L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}', {
                    attribution: 'Tiles &copy; Esri &mdash; Source: Esri, DeLorme, NAVTEQ, USGS, Intermap, iPC, NRCAN, Esri Japan, METI, Esri China (Hong Kong), Esri (Thailand), TomTom, 2012'
                }).addTo(map);
      }




    function map_refresh(map,options){
        leafletmaplanding_map.removeLayer(ggJSON)
        newMarkers.clearLayers()

        leafletmaplanding_map.addLayer(newMarkers)

        var items = []

        ///// IF YOU CHANGE THE LOCATION OF THE HIDDEN COORDINATES COLUMN, DON'T FORGET TO CHANGE THE NTH CHILD LOCATION

        //Iterate all td's in second column
        $('#myTable tbody tr td:nth-child(1)').each( function(){
           //add item to array
           items.push( $(this).text() );
        });



        var markers = []
        for(var i=0; i<items.length; i++){
            var test = items[i].replace(/\s/g, '')
            itest = test.split('][').join('] , [').split(' , ')

            for(var j=0; j<itest.length;j++){
                var jtest = itest[j].replace('[','').replace(']','').split(',')

                jlist = []
                for(var k=0; k<jtest.length;k++){
                    var parsed = parseFloat(jtest[k])
                    if(isNaN(parsed)){
                        //
                    } else {
                        jlist.push(parsed)
                    }
                }
                markers.push(jlist)
            }

        }



        for(var i=0; i< markers.length; i++){
            if(markers[i].length>0){
                marker = new L.circleMarker([markers[i][0],markers[i][1]],geojsonMarkerOptions).addTo(newMarkers)
            }
        }



     }

</script>